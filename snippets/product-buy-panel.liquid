{% include 'wh_calculate_discount' with product, hide_method: 'break' %}
{% assign current_variant = product.selected_or_first_available_variant %}
{% include 'wh_variant' with current_variant %}

{%- style -%}
.product-panel-background:before {
	background-image: url({{product.metafields.custom_fields["lefti_image"]}});
}
.product-panel-background:after {
	background-image: url({{product.metafields.custom_fields["right_image"]}});
}
.product_photo:before {
	background-image: url({{product.metafields.custom_fields["product_background_image"]}});
}
.panel-bg-image:after {
  background-image: url({{product.metafields.custom_fields["panel_background_image"]}});
}
{%- endstyle -%}

{% assign on_sale = false %}
{% if wh_v_compare_at_price > wh_v_price %}
  {% unless hide_on_sale_badge %}
    {% assign on_sale = true %}
  {% endunless %}
{% endif %}
{% assign in_stock = false %}
{% for variant in product.variants %}
  {% if variant.available %}
    {% assign in_stock = true %}
  {% endif %}
{% endfor %}

{% assign spice = '' %}
{% assign postPriceText = '' %}

{% for tag in product.tags %}
  {% if tag contains "spice_" %}
    {% assign spice = tag | remove: "spice_" %}
  {% endif %}
	{% if tag contains "postprice_" %}
		{% assign postPriceText = tag | remove: "postprice_" %}
	{% endif %}
{% endfor %}

{%- assign bundlerProduct = false -%}
{%- for collection in product.collections -%}
	{%- if collection.title == "Build Your Pack" -%}
		{%- assign bundlerProduct = true -%}
	{%- endif -%}
{%- endfor -%}

{% if product.metafields.custom_fields["fine_print"] != blank %}
	<div class="fine-print">
		<div class="page-width  flex-all-center">
			<h2>Hey!</h2>
			<div>
				{{ product.metafields.custom_fields["fine_print"] }}
			</div>
		</div>
	</div>
{% endif %}

<div class="buy-pannel">
  <div class="product-panel-background background-illustration  {{product.handle}} {% if product.type != 'Spice' %} default-background {% else %} {{spice}} {% endif %}">
  <div class="grid--inline product-single {% if section.settings.margins %}margins{% endif %}">

    <div class="product__panel-item">

      <div class="medium-down--hide">

        {% if product.metafields.custom_fields["switch_image_for_variants"] == 1 %}
          {% assign limit = product.images.length %}
          {% assign id = "ProductPhotoSlideshow" %}
        {% else %}
          {% assign limit = 1 %}
          {% assign id = "ProductGalleryStacked" %}
        {% endif %}

        <div id="{{ id }}" class="product-single__photos large--one-whole product_photo">

          {% for image in product.images limit: limit %}

          {% include "attribute-image-box-ratio" %}

          {% include "filter-rias-img-url" input: image %}
          {% assign image_url = output %}

          <div class="box-ratio" style="padding-bottom: {{ image_box_ratio }};" data-image-id="{{ image.id }}">
            <img
                 data-src="{{ image| product_img_url: '1000x' }}"
                 data-sizes="auto"
                 data-widths="[540, 720, 900, 1080, 1296, 1512, 1728, 1944, 2048]"
                 class="lazyload lazyload-fade"
                 data-image-id="{{ image.id }}"
                 alt="{{ image.alt | escape }}">

            <noscript>
              <img src="{{ image | img_url: '1000x' }}" alt="{{ image.alt }}" />
            </noscript>
          </div>
          {% else %}
          <img src="//cdn.shopify.com/s/images/themes/product-1.png">
          {% endfor %}
        </div>
      </div>

      {% comment %}
      Now create the mobile slideshow.
      {% endcomment %}
      <div class="large--hide">
        <div class="product-single__photos product_photo">
          {% for image in product.images limit:1 %}
	          {% include "filter-rias-img-url" input: image %}
	          {% assign image_url = output %}

	          <img
		          data-src="{{ image | product_img_url: '1000x' }}"
		          data-sizes="auto"
		          class="lazyload lazyload-fade"
		          alt="{{ image.alt | escape }}"
		          data-image-id="{{ image.id }}">
          {% endfor %}
        </div>

      </div>
    </div>

    <div class="product__panel-item {% if product.metafields.custom_fields["panel_background_image"] != blank %} panel-bg-image {% endif %}" >
      <div class="sidebarColumn-inner radial-gradient-bg-yellow">
        <div class="content-wrapper--title product-header-wrap">
				<!-- preorder badge -->
        {%- include 'dynamic-shipping-badge' -%}

				{% if section.settings.supertext  != blank %}
					<div class="supertext"> {{section.settings.supertext}} </div>
				{% endif %}
        <h1 itemprop="name" class='product-title'>{{ product.title }}</h1>

        <div itemprop="offers" itemscope itemtype="http://schema.org/Offer">
          <meta itemprop="priceCurrency" content="{{ shop.currency }}">
          <link itemprop="availability" href="http://schema.org/{% if product.available %}InStock{% else %}OutOfStock{% endif %}">

          <div id="AddToCartForm" class="product-form form-vertical ">

						<div class="product__price">
							<div class="money-flex flex--align-center">
								<span class="money" itemprop="price" data-product-price>
									<span class="font-weight-regular">{{ wh_v_price |  money_without_trailing_zeros  }}</span>
								</span>
								{% if wh_compare_at_price_max > wh_price %}
									<span class='strikethrough faded money' data-compare-price>
										{{ wh_v_compare_at_price |  money_without_trailing_zeros }}
									</span>
								{% endif %}

                {% if postPriceText != blank %}
                  <span> &nbsp;{{postPriceText}} </span>
                {% endif %}

                <div class="dabba-reviews reviews-badge pink-stars">
                  <a href="#shopify-product-reviews" class="product--reviews"><span class="shopify-product-reviews-badge " data-id="{{ product.id }}"></span></a>
                </div>
							</div>
						</div>

						{% if product.metafields.custom_fields["tasting_notes_profile"] != blank %}
					    <div class="custom-field--value">
					      {{ product.metafields.custom_fields["tasting_notes_profile"] }}
					    </div>
						{% endif %}

						{%- if product.has_only_default_variant and product.metafields.custom_fields["product_size"] == blank -%}
							{% form 'product', product, data-productid: product.id %}
								<div class=" sr-only">
									<select name="id" data-productid="{{ product.id }}" id="productSelect-{{ product.id }}" class=" product-single__variants">

										{% for variant in product.variants %}
  										{% include 'wh_variant' with variant, in_loop: true %}
  										{% if variant.available %}
  										{% comment %}
  										Note: if you use option_selection.js, your <select> tag will be overwritten, meaning what you have inside <option> will not reflect what you coded below.
  										{% endcomment %}

    										<option {% if variant == current_variant %} selected="selected" {% endif %} value="{{ variant.id }}" data-sku="{{ variant.sku }}">{{ variant.title }} - {{ loop_wh_v_price | money }}</option>

  										{% else %}
    										<option disabled="disabled">
    											{{ variant.title }} - {{ 'products.product.sold_out' | t }}
    										</option>
  										{% endif %}
										{% endfor %}
									</select>
								</div>

								<div class="product__button-quanity">
									{% include 'add-to-cart-button' %}

									<div class="quantity-input js organic-background">
										<img  data-src="{{'quantity-bg.png' | asset_img_url: 'master' }}" alt="" class="{% unless product.type == 'Spice' %} not-spice {% endunless %} lazyload lazyload-fade">
										<input type='button' value='-' class='qtyminus qtyadjust' field='quantity' />
										<input type="number" id="Quantity" name="quantity" value="1" min="1" class="quantity-selector js-quantityInput" autocomplete="off">
										<input type='button' value='+' class='qtyplus qtyadjust' field='quantity' />
									</div>
							</div>
							{% endform %}
						{%- endif -%}

            {% if in_stock == false %}
           	 <a class="btn" href="#" type="button" id="BIS_trigger" style="width: 100%; margin-top: 0.667em;">Email when available</a>
            {% endif %}

            {% comment %}
            Add product variants as a dropdown.
            - By default, each variant (or combination of variants) will display as its own <option>
            - To separate these into multiple steps, which we suggest, use option_selection.js (see below)

            You can leverage jQuery to add a callback on page load and each time the select element changes:
            - Include option_selection.js (as seen at the bottom of this file)
            - This allows you to use JavaScript anytime the variant dropdown changes
            - This also separates out your variant options (ie. size, color, etc.) to separate select elements

            For more information on products with multiple options, visit:
            - http://docs.shopify.com/support/your-website/themes/can-i-make-my-theme-use-products-with-multiple-options#update-product-liquid
            {% endcomment %}
        </div>
      </div>

    </div>
      </div>
    </div>
  </div>

</div>

{%- if product.has_only_default_variant == false or product.metafields.custom_fields["product_size"] != blank -%}
	{% form 'product', product, data-productid: product.id, class: "product-page-form pdp-form" %}

	{% if in_stock == true %}
		<div class="product-interaction-banner">
			<div class="product-size {% if product.has_only_default_variant %} wrap {% endif %}">
				{% if product.has_only_default_variant %}
					{% if product.metafields.custom_fields["product_size"] != blank %}
						<div class="single-size"> SIZE {{product.metafields.custom_fields["product_size"]}} </div>
					{% endif %}
					<div class=" sr-only">
						<select name="id" data-productid="{{ product.id }}" id="productSelect-{{ product.id }}" class=" product-single__variants">

							{% for variant in product.variants %}
							{% include 'wh_variant' with variant, in_loop: true %}
							{% if variant.available %}
							{% comment %}
							Note: if you use option_selection.js, your <select> tag will be overwritten, meaning what you have inside <option> will not reflect what you coded below.
							{% endcomment %}

              {% assign pre_order = product.metafields.custom_fields["pre-order"] %}

              {%- unless pre_order == 1 -%}
                {% assign pre_order = variant.metafields.custom_fields["pre-order"] %}
              {%- endunless -%}

              {% assign restock_date = product.metafields.custom_fields["restock_date"] %}
              {%- if restock_date == blank -%}
                {% assign restock_date = variant.metafields.custom_fields["restock_date"] %}
              {%- endif -%}

							<option {% if variant == current_variant %} selected="selected" {% endif %} value="{{ variant.id }}" data-sku="{{ variant.sku }}" data-preorder="{{ pre_order }}" data-restock="{{ restock_date }}">{{ variant.title }} - {{ loop_wh_v_price | money }}</option>
							{% else %}
							<option disabled="disabled">
								{{ variant.title }} - {{ 'products.product.sold_out' | t }}
							</option>
							{% endif %}
							{% endfor %}
						</select>
					</div>
				{% else %}
					<div class="select-wrapper">
						<select name="id" data-productid="{{ product.id }}" id="productSelect-{{ product.id }}" class="product-single__variants">

							{% for variant in product.variants %}
							{% include 'wh_variant' with variant, in_loop: true %}
							{% if variant.available %}


              {% assign pre_order = product.metafields.custom_fields["pre-order"] %}

              {%- unless pre_order == 1 -%}
                {% assign pre_order = variant.metafields.custom_fields["pre-order"] %}
              {%- endunless -%}

              {% assign restock_date = product.metafields.custom_fields["restock_date"] %}
              {%- if restock_date == blank -%}
                {% assign restock_date = variant.metafields.custom_fields["restock_date"] %}
              {%- endif -%}

							{% comment %}
							Note: if you use option_selection.js, your <select> tag will be overwritten, meaning what you have inside <option> will not reflect what you coded below.
							{% endcomment %}

							<option {% if variant == current_variant %} selected="selected" {% endif %} value="{{ variant.id }}" data-sku="{{ variant.sku }}" data-preorder="{{ pre_order }}" data-restock="{{ restock_date }}">{{ variant.title }} - {{ loop_wh_v_price | money }}</option>
							{% else %}
							<option disabled="disabled">
								{{ variant.title }} - {{ 'products.product.sold_out' | t }}
							</option>
							{% endif %}
							{% endfor %}
						</select>
					</div>
			  {% endif %}

				{% if product.metafields.custom_fields["show_harvest_notes_and_size_gu"] == 1 %}
					<div class="size-chart-link medium-down--hide">
						Not sure what size you need or how long it’ll last you? Our<a href="#size-chart"> spice size guide </a>can help!
					</div>
          <div class="size-chart-link mobile medium-up--hide">
						Not sure what size you need or how long it’ll last you? Our<a href="#size-guide"> spice size guide </a>can help!
					</div>
				{% endif %}
			</div>


			<div class="product__button-quanity">

        <div id="product__spoon-checkbox-container" class="product__spoon-checkbox-container">
          {% if in_stock == true %}
            <div class="spice-spoon-image-container hide"></div>
            <input id="spice-spoon-checkbox" type="checkbox" name="spice-spoon-checkbox" class="spice-spoon-checkbox__input" />
            <label for="spice-spoon-checkbox" id="spice-spoon-checkbox__label"><span>$1</span> add a spice spoon</label>
          {% elsif in_stock == false %}
          {% endif %}
        </div>
        <div class="flex">
  				<div class="quantity-input js organic-background">
  					<img  data-src="{{'quantity-bg.png' | asset_img_url: 'master' }}" alt="" class=" {% unless product.type == 'Spice' %} not-spice {% endunless %} lazyload lazyload-fade">
  					<input type='button' value='-' class='qtyminus qtyadjust' field='quantity' />
  					<input type="number" id="Quantity" name="quantity" value="1" min="1" class="quantity-selector js-quantityInput" autocomplete="off">
  					<input type='button' value='+' class='qtyplus qtyadjust' field='quantity' />
  				</div>

  				{% include 'add-to-cart-button' %}
        </div>
  		</div>

		</div>
			{%- include 'preorder-button' -%}
		{% else %}
			<div class="sr-only">
				<select name="id" data-productid="{{ product.id }}" id="productSelect-{{ product.id }}" class=" product-single__variants">

					{% for variant in product.variants %}
					{% include 'wh_variant' with variant, in_loop: true %}
					{% if variant.available %}

          {% assign pre_order = product.metafields.custom_fields["pre-order"] %}

          {%- unless pre_order == 1 -%}
            {% assign pre_order = variant.metafields.custom_fields["pre-order"] %}
          {%- endunless -%}

          {% assign restock_date = product.metafields.custom_fields["restock_date"] %}
          {%- if restock_date == blank -%}
            {% assign restock_date = variant.metafields.custom_fields["restock_date"] %}
          {%- endif -%}


					{% comment %}
					Note: if you use option_selection.js, your <select> tag will be overwritten, meaning what you have inside <option> will not reflect what you coded below.
					{% endcomment %}

					<option {% if variant == current_variant %} selected="selected" {% endif %} value="{{ variant.id }}" data-sku="{{ variant.sku }}" data-preorder="{{ pre_order }}" data-restock="{{ restock_date }}">{{ variant.title }} - {{ loop_wh_v_price | money }}</option>
					{% else %}
					<option disabled="disabled">
						{{ variant.title }} - {{ 'products.product.sold_out' | t }}
					</option>
					{% endif %}
					{% endfor %}
				</select>
			</div>
		{% endif %}

    {%- include 'preorder-modal' -%}
	{% endform %}
{%- endif -%}

</div>


<script>
$(document).ready( function() {
  var bottomofDiv = $(".buy-pannel").outerHeight(true) + 400;
  var mobile = window.matchMedia("(max-width: 700px)");

  if(mobile.matches) {
    $(window).scroll(function() {
      var scrollBottom = $(window).scrollTop() + $(window).height();

        if(bottomofDiv > scrollBottom ) {
            $(".product__secondary-button-container").addClass('animate').removeClass('reverse-animate');
        }
        else{
            $(".product__secondary-button-container").addClass('reverse-animate').removeClass('animate');
        }
      });
    } else {
        $(".product__secondary-button-container").addClass('animate')
    }
});
</script>
